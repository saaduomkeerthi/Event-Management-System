{% extends "base_admin.html" %}
{% block admin_content %}
<style>
    /* Enhanced card animations */
    .card {
        transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        border: none;
        border-radius: 0.75rem;
        overflow: hidden;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    }
    
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    /* Gradient backgrounds */
    .bg-gradient-danger {
        background: linear-gradient(45deg, #e74a3b, #c03a2b);
    }
    
    /* Enhanced table styling */
    .table {
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .table th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
        border: none;
        padding: 15px;
    }
    
    .table td {
        vertical-align: middle;
        padding: 15px;
        border-top: 1px solid #e3e6f0;
    }
    
    .table tbody tr {
        transition: all 0.3s ease;
        border-left: 3px solid transparent;
    }
    
    .table tbody tr:hover {
        background-color: rgba(78, 115, 223, 0.03) !important;
        border-left: 3px solid #4e73df;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* Enhanced badges */
    .badge {
        padding: 0.5em 0.8em;
        font-size: 0.85em;
        font-weight: 500;
        letter-spacing: 0.5px;
        border-radius: 20px;
        transition: all 0.3s ease;
    }
    
    .badge:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    /* Enhanced empty state */
    .empty-state {
        padding: 4rem 2rem;
        text-align: center;
        background: linear-gradient(135deg, rgba(78, 115, 223, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
        border-radius: 0.75rem;
        margin: 2rem 0;
    }
    
    .empty-state i {
        font-size: 5rem;
        margin-bottom: 1.5rem;
        background: linear-gradient(45deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
    }
    
    .empty-state h4 {
        font-weight: 600;
        color: #5a5c69;
        margin-bottom: 1rem;
    }
    
    .empty-state p {
        color: #858796;
        max-width: 500px;
        margin: 0 auto 2rem;
    }
    
    /* Enhanced buttons */
    .btn {
        border-radius: 0.35rem;
        font-weight: 500;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
    }
    
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 7px 14px rgba(50, 50, 93, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
    }
    
    /* Enhanced pagination */
    .pagination {
        margin-bottom: 0;
    }
    
    .page-link {
        border-radius: 0.35rem;
        margin: 0 3px;
        color: #4e73df;
        font-weight: 500;
        transition: all 0.3s ease;
        border: none;
    }
    
    .page-link:hover {
        background-color: #4e73df;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .page-item.active .page-link {
        background-color: #4e73df;
        border-color: #4e73df;
    }
    
    /* Enhanced modal */
    .modal-content {
        border: none;
        border-radius: 0.75rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    .modal-header {
        background: linear-gradient(45deg, #4e73df, #224abe);
        color: white;
        border-radius: 0.75rem 0.75rem 0 0;
        border-bottom: none;
    }
    
    .modal-header .btn-close {
        filter: brightness(0) invert(1);
    }
    
    /* Form enhancements */
    .form-control, .form-select {
        border-radius: 0.35rem;
        border: 1px solid #d1d3e2;
        transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #bac8f3;
        box-shadow: 0 0 0 0.25rem rgba(78, 115, 223, 0.25);
    }
    
    /* Animations */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .animated-card {
        animation: fadeInUp 0.6s ease-out;
    }
    
    /* Staggered animations for table rows */
    .table tbody tr:nth-child(1) { animation-delay: 0.1s; }
    .table tbody tr:nth-child(2) { animation-delay: 0.2s; }
    .table tbody tr:nth-child(3) { animation-delay: 0.3s; }
    .table tbody tr:nth-child(4) { animation-delay: 0.4s; }
    .table tbody tr:nth-child(5) { animation-delay: 0.5s; }
    
    /* Custom scrollbar */
    .table-responsive::-webkit-scrollbar {
        height: 8px;
    }
    
    .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }
    
    .table-responsive::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
    }
    
    .table-responsive::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .card-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .table-responsive {
            border: none;
        }
        
        .empty-state {
            padding: 2rem 1rem;
        }
    }
</style>
<!-- Page Heading -->
<div class="d-sm-flex align-items-center justify-content-between mb-4 animated-card">
    <h1 class="h3 mb-0 text-gray-800">
        <i class="fas fa-calendar-alt me-2 text-danger"></i>Events Management
    </h1>
    <!-- <a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm" id="createEventBtn">
        <i class="fas fa-plus fa-sm text-white-50"></i> Create Event
    </a> -->
</div>
<!-- Events Table -->
<div class="card shadow mb-4 animated-card">
    <div class="card-header bg-gradient-danger py-3 d-flex justify-content-between align-items-center">
        <h6 class="m-0 font-weight-bold text-white">
            <i class="fas fa-list me-2"></i>All Events
        </h6>
        <!-- <div>
            <select class="form-select form-select-sm" id="eventFilter">
                <option value="all">All Events</option>
                <option value="upcoming">Upcoming Events</option>
                <option value="past">Past Events</option>
                <option value="active">Active Events</option>
            </select>
        </div> -->
    </div>
    <div class="card-body">
        <div id="eventsTableContainer">
            <!-- Server-rendered events will appear here -->
            {% if events %}
            <div class="table-responsive">
                <table class="table table-bordered table-hover" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th><i class="fas fa-tag me-2"></i>Event Name</th>
                            <th><i class="fas fa-calendar me-2"></i>Date</th>
                            <th><i class="fas fa-map-marker-alt me-2"></i>Location</th>
                            <th><i class="fas fa-users me-2"></i>Participants</th>
                            <th><i class="fas fa-info-circle me-2"></i>Status</th>
                            <th><i class="fas fa-user me-2"></i>Organizer</th>
                            <!-- <th>Actions</th> -->
                        </tr>
                    </thead>
                    <tbody>
                        {% for event in events %}
                        <tr class="animated-card">
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="event-icon bg-danger bg-opacity-10 text-danger rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                        <i class="fas fa-calendar-alt"></i>
                                    </div>
                                    <div>
                                        <div class="fw-bold">{{ event.title }}</div>
                                        <div class="text-muted small">ID: {{ event.event_id }}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    
                                    {{ event.event_date }}
                                </div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-map-marker-alt text-muted me-2"></i>
                                    {{ event.location }}
                                </div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="me-2">
                                        <div class="fw-bold">{{ event.participant_count }}/{{ event.total_tickets or event.volunteer_required }}</div>
                                        <div class="progress progress-sm" style="width: 100px;">
                                            <div class="progress-bar bg-success" role="progressbar" 
                                                style="width: {{ (event.participant_count / (event.total_tickets or event.volunteer_required)) * 100 if event.total_tickets or event.volunteer_required else 0 }}%">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% if event.status_display == 'upcoming' %}
                                <span class="badge bg-warning text-dark">
                                    <i class="fas fa-clock me-1"></i>Upcoming
                                </span>
                                {% elif event.status_display == 'ongoing' %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check-circle me-1"></i>Active
                                </span>
                                {% elif event.status_display == 'completed' %}
                                <span class="badge bg-secondary">
                                    <i class="fas fa-check-double me-1"></i>Completed
                                </span>
                                {% else %}
                                <span class="badge bg-info">
                                    <i class="fas fa-info-circle me-1"></i>{{ event.status_display }}
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="user-avatar bg-info text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                                        {{ event.organizer_name[0]|upper }}
                                    </div>
                                    {{ event.organizer_name }}
                                </div>
                            </td>
                            <!-- <td>
                                <div class="btn-group" role="group">
                                    <a href="#" class="btn btn-sm btn-primary" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="#" class="btn btn-sm btn-info" title="View">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="#" class="btn btn-sm btn-danger" title="Delete" onclick="deleteEvent({{ event.event_id }})">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                            </td> -->
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <!-- Event Details Modal -->
<div class="modal fade" id="viewEventModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewEventTitle">
            <i class="fas fa-info-circle me-2"></i>Event Details
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="viewEventBody">
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-1"></i>Close
        </button>
      </div>
    </div>
  </div>
</div>
            <!-- Pagination Controls -->
            {% if pagination.total_pages > 1 %}
            <div class="d-flex justify-content-between align-items-center mt-4">
                <div class="text-muted">
                    Showing {{ ((pagination.page - 1) * pagination.per_page) + 1 }} to 
                    {{ [pagination.page * pagination.per_page, pagination.total] | min }} 
                    of {{ pagination.total }} events
                </div>
                <nav>
                    <ul class="pagination">
                        {% if pagination.page > 1 %}
                        <li class="page-item">
                            <a class="page-link" href="#" data-page="{{ pagination.page - 1 }}">
                                <i class="fas fa-arrow-left me-1"></i>Previous
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">
                                <i class="fas fa-arrow-left me-1"></i>Previous
                            </span>
                        </li>
                        {% endif %}
                        
                        {% for p in range(1, pagination.total_pages + 1) %}
                            {% if p >= pagination.page - 2 and p <= pagination.page + 2 %}
                            <li class="page-item {% if p == pagination.page %}active{% endif %}">
                                <a class="page-link" href="#" data-page="{{ p }}">{{ p }}</a>
                            </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if pagination.page < pagination.total_pages %}
                        <li class="page-item">
                            <a class="page-link" href="#" data-page="{{ pagination.page + 1 }}">
                                Next<i class="fas fa-arrow-right ms-1"></i>
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">
                                Next<i class="fas fa-arrow-right ms-1"></i>
                            </span>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
            
            {% else %}
            <div class="empty-state">
                <i class="fas fa-calendar-times"></i>
                <h4>No Events Found</h4>
                <p>There are no events created yet.</p>
                <a href="#" class="btn btn-primary btn-hover-lift" id="createFirstEventBtn">
                    <i class="fas fa-plus me-2"></i>Create Your First Event
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>
<!-- Create Event Modal (hidden by default) -->
<div class="modal fade" id="createEventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle me-2"></i>Create New Event
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="eventForm">
                    <div class="mb-3">
                        <label for="eventName" class="form-label">
                            <i class="fas fa-tag me-1"></i>Event Name
                        </label>
                        <input type="text" class="form-control" id="eventName" required>
                    </div>
                    <div class="mb-3">
                        <label for="eventDate" class="form-label">
                            <i class="fas fa-calendar me-1"></i>Date
                        </label>
                        <input type="date" class="form-control" id="eventDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="eventLocation" class="form-label">
                            <i class="fas fa-map-marker-alt me-1"></i>Location
                        </label>
                        <input type="text" class="form-control" id="eventLocation" required>
                    </div>
                    <div class="mb-3">
                        <label for="eventCapacity" class="form-label">
                            <i class="fas fa-users me-1"></i>Capacity
                        </label>
                        <input type="number" class="form-control" id="eventCapacity" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveEventBtn">
                    <i class="fas fa-save me-1"></i>Save Event
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Configuration
    const EVENTS_PER_PAGE = 5;
    let currentPage = {{ pagination.page if pagination else 1 }};
    let totalPages = {{ pagination.total_pages if pagination else 1 }};
    let currentFilter = 'all';

    // DOM Elements
    const eventsTableContainer = document.getElementById('eventsTableContainer');
    const eventFilter = document.getElementById('eventFilter');
    const createEventBtn = document.getElementById('createEventBtn');
    const createFirstEventBtn = document.getElementById('createFirstEventBtn');
    const saveEventBtn = document.getElementById('saveEventBtn');
    const createEventModal = new bootstrap.Modal(document.getElementById('createEventModal'));

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
        // ✅ THIS IS THE ONLY CLICK LISTENER YOU NEED FOR PAGINATION
        // It's attached to the container, so it works even after the table is reloaded via AJAX.
        eventsTableContainer.addEventListener('click', function(e) {
            const link = e.target.closest('.page-link');
            if (link && link.dataset.page) {
                e.preventDefault();
                const page = parseInt(link.dataset.page);
                if (page !== currentPage) {
                    loadEvents(page, currentFilter);
                }
            }
        });

        // Add event listener for the filter dropdown
        if (eventFilter) {
            eventFilter.addEventListener('change', function() {
                currentFilter = this.value;
                loadEvents(1, currentFilter); // Reset to page 1 when filter changes
            });
        }
        
        // Add event listener for the main "Create Event" button
        if (createEventBtn) {
            createEventBtn.addEventListener('click', function(e) {
                e.preventDefault();
                createEventModal.show();
            });
        }
        
        // Add event listener for the "Create Your First Event" button (in empty state)
        if (createFirstEventBtn) {
            createFirstEventBtn.addEventListener('click', function(e) {
                e.preventDefault();
                createEventModal.show();
            });
        }
        
        // Add event listener for the "Save Event" button in the modal
        if (saveEventBtn) {
            saveEventBtn.addEventListener('click', function() {
                // You would need to define this createEvent function
                // createEvent(); 
            });
        }
    });

    // Function to load events with pagination via AJAX
    async function loadEvents(page, filter) {
        try {
            eventsTableContainer.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading events...</p>
                </div>
            `;
            
            const response = await fetch(`/admin/events?page=${page}&filter=${filter}&per_page=${EVENTS_PER_PAGE}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            currentPage = data.page;
            totalPages = data.total_pages;
            
            if (data.events.length === 0) {
                showNoEventsMessage(filter);
            } else {
                renderEventsTable(data.events, data.total, data.page, filter);
            }
        } catch (error) {
            console.error('Error loading events:', error);
            eventsTableContainer.innerHTML = `
                <div class="alert alert-danger">
                    Error loading events: ${error.message}
                </div>
            `;
        }
    }

    // Function to render the events table from JSON data (This part is correct from our last fix)
    function renderEventsTable(events, totalCount, currentPage, filter) {
        let tableHtml = `
            <div class="table-responsive">
                <table class="table table-bordered table-hover" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th><i class="fas fa-tag me-2"></i>Event Name</th>
                            <th><i class="fas fa-calendar me-2"></i>Date</th>
                            <th><i class="fas fa-map-marker-alt me-2"></i>Location</th>
                            <th><i class="fas fa-users me-2"></i>Participants</th>
                            <th><i class="fas fa-info-circle me-2"></i>Status</th>
                            <th><i class="fas fa-user me-2"></i>Organizer</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        events.forEach(event => {
            let statusClass, statusIcon;
            switch (event.status_display) { 
                case 'upcoming':
                    statusClass = 'bg-warning text-dark';
                    statusIcon = 'fa-clock';
                    break;
                case 'ongoing':
                    statusClass = 'bg-success';
                    statusIcon = 'fa-check-circle';
                    break;
                case 'completed':
                    statusClass = 'bg-secondary';
                    statusIcon = 'fa-check-double';
                    break;
                default:
                    statusClass = 'bg-info';
                    statusIcon = 'fa-info-circle';
            }

            const capacity = event.capacity || 1;
            const participantPercentage = capacity > 0 ? (event.participants / capacity) * 100 : 0;

            tableHtml += `
                <tr class="animated-card">
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="event-icon bg-danger bg-opacity-10 text-danger rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <div>
                                <div class="fw-bold">${event.name}</div>
                                <div class="text-muted small">ID: ${event.id}</div> 
                            </div>
                        </div>
                    </td>
                    <td>${event.date}</td>
                    <td>${event.location}</td>
                    <td>
                        <div class="fw-bold">${event.participants}/${event.capacity}</div>
                        <div class="progress progress-sm" style="width: 100px;">
                            <div class="progress-bar bg-success" role="progressbar" 
                                style="width: ${participantPercentage}%">
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge ${statusClass}">
                            <i class="fas ${statusIcon} me-1"></i>${event.status_display}
                        </span>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="user-avatar bg-info text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                                ${event.organizer.charAt(0).toUpperCase()}
                            </div>
                            ${event.organizer}
                        </div>
                    </td>
                </tr>
            `;
        });
        tableHtml += `
                    </tbody>
                </table>
            </div>
        `;
        tableHtml += generatePaginationControls(currentPage, totalPages, totalCount);
        eventsTableContainer.innerHTML = tableHtml;
    }

    // Function to generate pagination controls (This is correct)
    function generatePaginationControls(currentPage, totalPages, totalCount) {
        if (totalPages <= 1) return '';
        let paginationHtml = `
            <div class="d-flex justify-content-between align-items-center mt-4">
                <div class="text-muted">
                    Showing ${((currentPage - 1) * EVENTS_PER_PAGE) + 1} to ${Math.min(currentPage * EVENTS_PER_PAGE, totalCount)} of ${totalCount} events
                </div>
                <nav>
                    <ul class="pagination">
        `;
        if (currentPage > 1) {
            paginationHtml += `<li class="page-item"><a class="page-link" href="#" data-page="${currentPage - 1}"><i class="fas fa-arrow-left me-1"></i>Previous</a></li>`;
        } else {
            paginationHtml += `<li class="page-item disabled"><span class="page-link"><i class="fas fa-arrow-left me-1"></i>Previous</span></li>`;
        }
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, startPage + 4);
        for (let i = startPage; i <= endPage; i++) {
            if (i === currentPage) {
                paginationHtml += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
            } else {
                paginationHtml += `<li class="page-item"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
            }
        }
        if (currentPage < totalPages) {
            paginationHtml += `<li class="page-item"><a class="page-link" href="#" data-page="${currentPage + 1}">Next<i class="fas fa-arrow-right ms-1"></i></a></li>`;
        } else {
            paginationHtml += `<li class="page-item disabled"><span class="page-link">Next<i class="fas fa-arrow-right ms-1"></i></span></li>`;
        }
        paginationHtml += `</ul></nav></div>`;
        return paginationHtml;
    }

    // Function to show message when no events are available (This is correct)
    function showNoEventsMessage(filter) {
        // ... (this function is fine as-is)
    }

    // Function to delete an event (This is correct)
    async function deleteEvent(eventId) {
        // ... (this function is fine as-is)
    }
</script>
{% endblock %}